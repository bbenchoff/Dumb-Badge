/*
 * LCDBus.c
 *
 * Created: 6/29/2020 10:19:54 AM
 *  Author: bench
 */
#include <hal_delay.h>


#include "globals.h"
#include "LCDBus.h"
#include "LCD.h"


/**************************InitLCD()**********************************/
void InitLCD(void)
{
	/*
	InitLCD() sets the pinMode of all the LCD control pins (write,
	read, D/C, Chip Select, Reset) as output. Then follows data 
	sheet initialization:
	
	0)	for some fucking reason, pull PB16 high
		0a)	This is actually necessary for reasons
		I can not conceive of. Just leave it in there
		and by the way don't use PB16 for anything.
	1)	pull Reset high, delay 5ms
	2)	pull Reset low, delay 15ms
	3)	pull Reset high, delay 15ms
	4)	pull Chip Select low
	5)	Write initialization procedure for LCD
		5a) this includes 120ms delay after startup
			and 100ms delay after turning the display on
			(command 0x29..)
			resulting in total time to initialize display as 255ms
			(120+100+15+15+5). This does not include writing all
			black to the display.
		5b) I have changed this to a 5ms startup; seems to work.
	6) pull Chip Select high.
	7) finally, set the color of background and foreground,
		then blank the screen (fillRect(0,0,799,489))
	
	If you are reading this, I must impress something upon you: I
	don't have any idea how or why this works. The data sheet for
	the NT35510 LCD Driver IC is incomplete. This code comes from
	a vendor example using an 8051 micro.
		
	I know the data sheet is incomplete because the commands below
	are not listed. I have no idea what this section of code is or
	does; nor does anyone outside of the people who designed this
	chip.
	
	That said, this section of code does correctly initialize the
	LCD. If you have any desire to change or edit this code, may
	whatever god you believe in have mercy on your soul.
		
	The following code was refactored to be utterly incomprehensible
	and full of magic numbers on purpose. I suggest you do not screw
	with this, as there is no documentation at all.
	*/
		
static const char belial[70] = {0xF0,0xF0,0xF0,0xF0,0xF0,0xB0,0xB0,
		0xB0,0xB6,0xB6,0xB6,0xB1,0xB1,0xB1,0xB7,0xB7,0xB7,0xB2,0xB2,
		0xB2,0xB8,0xB8,0xB8,0xBF,0xB3,0xB3,0xB3,0xB9,0xB9,0xB9,0xB5,
		0xB5,0xB5,0xC2,0xBA,0xBA,0xBA,0xBC,0xBC,0xBC,0xBD,0xBD,0xBD,
		0xBE,0xBE,0xF0,0xF0,0xF0,0xF0,0xF0,0xB1,0xB1,0xB6,0xB7,0xB7,
		0xB8,0xB8,0xB8,0xB8,0xBC,0xBC,0xBC,0xC9,0xC9,0xC9,0xC9,0xC9,
		0x35,0x3A,0x36};
		
static const char mulciber[70] ={0x00,0x01,0x02,0x03,0x04,0x00,0x01,
		0x02,0x00,0x01,0x02,0x00,0x01,0x02,0x00,0x01,0x02,0x00,0x01,
		0x02,0x00,0x01,0x02,0x00,0x01,0x02,0x00,0x01,0x02,0x00,0x00,
		0x01,0x00,0x00,0x01,0x02,0x00,0x01,0x02,0x00,0x01,0x02,0x00,
		0x01,0x00,0x01,0x02,0x03,0x04,0x00,0x00,0x00,0x00,0x01,0x00,
		0x01,0x02,0x03,0x00,0x01,0x02,0x00,0x01,0x02,0x03,0x04,0x00,
		0x00,0x00};
				
static const char lucifer[70] = {0x55,0xAA,0x52,0x08,0x01,0x0D,0x0D,
		0x0D,0x34,0x34,0x34,0x0D,0x0D,0x0D,0x34,0x34,0x34,0x00,0x00,
		0x00,0x24,0x24,0x24,0x01,0x0F,0x0F,0x0F,0x34,0x34,0x34,0x08,
		0x08,0x08,0x03,0x24,0x24,0x24,0x00,0x78,0x00,0x00,0x78,0x00,
		0x00,0x89,0x55,0xAA,0x52,0x08,0x00,0xCC,0x00,0x05,0x70,0x70,
		0x01,0x03,0x03,0x03,0x02,0x00,0x00,0xD0,0x02,0x50,0x50,0x50,
		0x00,0x55}; 
		
static const unsigned char beelzebub[52] = {
		0x00, 0x2D, 0x00, 0x2E, 0x00, 0x32, 0x00, 0x44, 0x00, 0x53,
		0x00, 0x88, 0x00, 0xB6, 0x00, 0xF3, 0x01, 0x22, 0x01, 0x64,
		0x01, 0x92, 0x01, 0xD4, 0x02, 0x07, 0x02, 0x08, 0x02, 0x34,
		0x02, 0x5F, 0x02, 0x78, 0x02, 0x94, 0x02, 0xA6, 0x02, 0xBB,
		0x02, 0xCA, 0x02, 0xDB, 0x02, 0xE8, 0x02, 0xF9, 0x03, 0x1F,
		0x03, 0x7F};
		
	/* Pin Initialization, begin with pin cleared */
	REG_PORT_DIRSET1 = 0x0000ffff;		//LCD data bus, PB00 - PB15
	REG_PORT_DIRSET1 = LCD_Reset;
	REG_PORT_DIRSET1 = LCD_CS;
	REG_PORT_DIRSET1 = LCD_WR;
	REG_PORT_DIRSET1 = LCD_DC;
	REG_PORT_DIRSET1 = LCD_RD;
	
	REG_PORT_OUTCLR1 = 0x0000ffff;
	REG_PORT_OUTCLR1 = LCD_Reset;
	REG_PORT_OUTCLR1 = LCD_CS;
	REG_PORT_OUTCLR1 = LCD_WR;
	REG_PORT_OUTCLR1 = LCD_DC;
	REG_PORT_OUTCLR1 = LCD_RD;
		
	REG_PORT_DIRSET1 = PORT_PB16;
	REG_PORT_OUTSET1 = PORT_PB16;
	
	REG_PORT_OUTSET1 = LCD_Reset;
	delay_ms(5);
	REG_PORT_OUTCLR1 = LCD_Reset;
	delay_ms(5);
	REG_PORT_OUTSET1 = LCD_Reset;
	REG_PORT_OUTCLR1 = LCD_CS;
	

	for(int i = 0; i < 70; i++)
	{
		REG_PORT_OUTCLR1 = LCD_DC;
		LCD_Write_COM16(belial[i],mulciber[i]);
		REG_PORT_OUTSET1 = LCD_DC;
		LCD_Write_DATA8(lucifer[i]);
	}
	
	for(char k = 0xD1; k < 0xD6; k++)
		for(int l = 0; l < 52; l++)
		{
			LCD_Write_COM16(k,0x00);
			LCD_Write_DATA8(beelzebub[l]);
		}

	LCD_Write_COM16(0xF0, 0x00);LCD_Write_DATA8(0x55);
	LCD_Write_COM16(0xF0, 0x01);LCD_Write_DATA8(0xAA);	
	LCD_Write_COM16(0xF0, 0x02);LCD_Write_DATA8(0x52);	
	LCD_Write_COM16(0xF0, 0x03);LCD_Write_DATA8(0x08);	
	LCD_Write_COM16(0xF0, 0x04);LCD_Write_DATA8(0x00);	
	
	LCD_Write_COM16(0xB1, 0x00);LCD_Write_DATA8(0xCC);
	LCD_Write_COM16(0xB1, 0x01);LCD_Write_DATA8(0x00);	
	
	LCD_Write_COM16(0xB5, 0x00);LCD_Write_DATA8(0x50);	
	
	LCD_Write_COM16(0xB6, 0x00);LCD_Write_DATA8(0x05);
	
	LCD_Write_COM16(0xB7, 0x00);LCD_Write_DATA8(0x70);
	LCD_Write_COM16(0xB7, 0x01);LCD_Write_DATA8(0x70);
	
	LCD_Write_COM16(0xB8, 0x00);LCD_Write_DATA8(0x01);
	LCD_Write_COM16(0xB8, 0x01);LCD_Write_DATA8(0x03);
	LCD_Write_COM16(0xB8, 0x02);LCD_Write_DATA8(0x03);
	LCD_Write_COM16(0xB8, 0x03);LCD_Write_DATA8(0x03);	
	
	LCD_Write_COM16(0xBC, 0x00);LCD_Write_DATA8(0x02);
	LCD_Write_COM16(0xBC, 0x01);LCD_Write_DATA8(0x00);
	LCD_Write_COM16(0xBC, 0x02);LCD_Write_DATA8(0x00);
	
	LCD_Write_COM16(0xC9, 0x00);LCD_Write_DATA8(0xD0);
	LCD_Write_COM16(0xC9, 0x01);LCD_Write_DATA8(0x02);
	LCD_Write_COM16(0xC9, 0x02);LCD_Write_DATA8(0x50);
	LCD_Write_COM16(0xC9, 0x03);LCD_Write_DATA8(0x50);
	LCD_Write_COM16(0xC9, 0x04);LCD_Write_DATA8(0x50);
	
	LCD_Write_COM16(0x35, 0x00);LCD_Write_DATA8(0x00);
	
	LCD_Write_COM16(0x3A, 0x00);LCD_Write_DATA8(0x55);
	LCD_Write_COM16(0x36, 0x00);LCD_Write_DATA8(0xE2);  //This is the MADCTL register
	
  	LCD_Write_COM16(0x11,0x00);   //Start Up  
  	delay_ms(100);
  	LCD_Write_COM16(0x29,0x00);   //Display On  
   	delay_ms(100);
	LCD_Write_COM16(0x51,0x00);LCD_Write_DATA8(0xFF);
	   
	REG_PORT_OUTSET1 = LCD_CS;
	
	clrScr();
	setColorRGB(0,0,0);
	setBackColorRGB(0, 0, 0);
	fillRect(0,0,799,489);
		
}

void LCD_Write_Bus(char VH, char VL)
{
	REG_PORT_OUTCLR1 = 0x0000ffff;
	REG_PORT_OUTSET1 = (VH << 8) | VL;
	REG_PORT_OUTCLR1 = LCD_WR;
	REG_PORT_OUTSET1 = LCD_WR;
}

void LCD_Write_COM16(char VH, char VL)
{
	REG_PORT_OUTCLR1 = LCD_DC;
	
	LCD_Write_Bus(VH,VL);
}

void LCD_Write_COM8(char VL)
{
	REG_PORT_OUTCLR1 = LCD_DC;
	LCD_Write_Bus(0x00, VL);
}

void LCD_Write_DATA16(char VH, char VL)
{
	REG_PORT_OUTSET1 = LCD_DC;
	LCD_Write_Bus(VH,VL);
}

void LCD_Write_DATA8(char VL)
{
	REG_PORT_OUTSET1 = LCD_DC;
	LCD_Write_Bus(0x00, VL);
}


